#compdef grin.py

# Zsh completion for GRIN-to-S3 unified CLI
# To install: source this file or place in your fpath

_grin_run_names() {
    local -a run_names
    if [[ -d "output" ]]; then
        run_names=(${(f)"$(find output -maxdepth 1 -type d -not -name output | sed 's|output/||')"})
        _describe 'run names' run_names
    fi
}

_grin_storage_types() {
    _values 'storage type' \
        'local[Local filesystem storage]' \
        'minio[MinIO S3-compatible storage]' \
        'r2[Cloudflare R2 storage]' \
        's3[Amazon S3 storage]'
}

_grin_log_levels() {
    _values 'log level' \
        'DEBUG[Detailed debug information]' \
        'INFO[General information]' \
        'WARNING[Warning messages only]' \
        'ERROR[Error messages only]'
}

_grin_sync_status() {
    _values 'sync status filter' \
        'pending[Books not yet synced]' \
        'failed[Books that failed to sync]'
}

_grin() {
    local context state line
    _arguments \
        '1:command:->commands' \
        '--help[Show help message]' \
        '*::arg:->args'
    
    case $state in
        commands)
            _values 'grin commands' \
                'auth[Set up OAuth2 authentication]' \
                'collect[Collect book metadata from GRIN]' \
                'process[Request and monitor book processing]' \
                'sync-pipeline[Sync converted books to storage]' \
                'sync-status[Check sync status]' \
                'sync-catchup[Download already-converted books]' \
                'storage[Manage storage buckets]' \
                'enrich[Enrich books with GRIN metadata]' \
                'export-csv[Export enriched data to CSV]' \
                'status[Show enrichment status]'
            ;;
        args)
            case $line[1] in
                auth)
                    _arguments \
                        'setup[Interactive credential setup]'
                    ;;
                collect)
                    _arguments \
                        '--run-name[Run name for organized output]:run name:' \
                        '--storage[Storage backend]:storage type:_grin_storage_types' \
                        '--bucket-raw[Raw data bucket name]:bucket name:' \
                        '--bucket-meta[Metadata bucket name]:bucket name:' \
                        '--bucket-full[Full-text bucket name]:bucket name:' \
                        '--storage-config[Additional storage config]:config:' \
                        '--limit[Limit number of books]:number:' \
                        '--rate-limit[API requests per second]:rate:' \
                        '--secrets-dir[Directory with GRIN secrets]:directory:_directories' \
                        '--write-config[Write run configuration]' \
                        '--test-mode[Use test data instead of GRIN]' \
                        '--config-file[Custom config file]:file:_files' \
                        '--create-config[Create default config]:file:_files' \
                        '--log-level[Logging level]:level:_grin_log_levels'
                    ;;
                process)
                    local proc_context proc_state proc_line
                    _arguments \
                        '1:subcommand:->subcommands' \
                        '--run-name[Run name]:run name:_grin_run_names' \
                        '*::arg:->subargs'
                    
                    case $proc_state in
                        subcommands)
                            _values 'process subcommands' \
                                'request[Request processing for books]' \
                                'monitor[Monitor processing progress]'
                            ;;
                        subargs)
                            case $proc_line[1] in
                                request)
                                    _arguments \
                                        '--limit[Limit number of books to request]:number:' \
                                        '--batch-size[Batch size for requests]:number:' \
                                        '--secrets-dir[Directory with GRIN secrets]:directory:_directories' \
                                        '--queue-report-interval[Queue monitoring interval]:seconds:' \
                                        '--log-level[Logging level]:level:_grin_log_levels'
                                    ;;
                                monitor)
                                    _arguments \
                                        '--converted[Show converted books]' \
                                        '--in-process[Show books being processed]' \
                                        '--failed[Show failed books]' \
                                        '--search[Search for specific barcode]:barcode:' \
                                        '--export[Export converted books]:file:_files' \
                                        '--limit[Limit results]:number:' \
                                        '--watch[Watch mode - poll every 5 minutes]' \
                                        '--secrets-dir[Directory with GRIN secrets]:directory:_directories' \
                                        '--log-level[Logging level]:level:_grin_log_levels'
                                    ;;
                            esac
                            ;;
                    esac
                    ;;
                sync-pipeline|sync-catchup)
                    _arguments \
                        '--run-name[Run name]:run name:_grin_run_names' \
                        '--storage[Storage backend]:storage type:_grin_storage_types' \
                        '--bucket-raw[Raw data bucket]:bucket name:' \
                        '--bucket-meta[Metadata bucket]:bucket name:' \
                        '--bucket-full[Full-text bucket]:bucket name:' \
                        '--credentials-file[Credentials file]:file:_files' \
                        '--concurrent[Concurrent downloads]:number:' \
                        '--batch-size[Batch size]:number:' \
                        '--limit[Limit number of books]:number:' \
                        '--force[Force overwrite existing files]' \
                        '--secrets-dir[Directory with GRIN secrets]:directory:_directories' \
                        '--gpg-key-file[GPG key file]:file:_files' \
                        '--log-level[Logging level]:level:_grin_log_levels'
                    ;;
                sync-status)
                    _arguments \
                        '--run-name[Run name]:run name:_grin_run_names' \
                        '--storage-type[Filter by storage type]:storage type:_grin_storage_types'
                    ;;
                enrich)
                    _arguments \
                        '--run-name[Run name]:run name:_grin_run_names' \
                        '--rate-limit[Delay between requests]:seconds:' \
                        '--batch-size[Batch size]:number:' \
                        '--max-concurrent[Max concurrent requests]:number:' \
                        '--limit[Limit number of books]:number:' \
                        '--reset[Reset enrichment data]' \
                        '--secrets-dir[Directory with GRIN secrets]:directory:_directories' \
                        '--log-level[Logging level]:level:_grin_log_levels'
                    ;;
                export-csv)
                    _arguments \
                        '--run-name[Run name]:run name:_grin_run_names' \
                        '--output[Output CSV file]:file:_files' \
                        '--log-level[Logging level]:level:_grin_log_levels'
                    ;;
                storage)
                    local storage_context storage_state storage_line
                    _arguments \
                        '1:subcommand:->subcommands' \
                        '--run-name[Run name]:run name:_grin_run_names' \
                        '*::arg:->subargs'
                    
                    case $storage_state in
                        subcommands)
                            _values 'storage subcommands' \
                                'ls[List contents of all storage buckets]' \
                                'rm[Remove all contents from a storage bucket]'
                            ;;
                        subargs)
                            case $storage_line[1] in
                                ls)
                                    _arguments \
                                        '-l[Use long listing format with file sizes]' \
                                        '--long[Use long listing format with file sizes]'
                                    ;;
                                rm)
                                    _arguments \
                                        '1:bucket:(raw meta full)' \
                                        '--yes[Auto-confirm without prompting]' \
                                        '-y[Auto-confirm without prompting]' \
                                        '--dry-run[Show what would be deleted without deleting]'
                                    ;;
                            esac
                            ;;
                    esac
                    ;;
                status)
                    _arguments \
                        '--run-name[Run name]:run name:_grin_run_names'
                    ;;
            esac
            ;;
    esac
}

_grin "$@"