%%{init: {"theme": "base", "themeVariables": {"primaryTextColor": "#1e293b", "primaryBorderColor": "#475569", "lineColor": "#64748b", "background": "transparent", "mainBkg": "transparent", "secondBkg": "transparent"}}}%%
flowchart TD
    subgraph Collect Pipeline
        A([Start run<br/>grin collect]):::terminal --> B[Init run config & storage settings]:::process
        B --> C[Validate GRIN auth]:::process
        C --> D[Stream all_books metadata pages]:::process
        D --> E[(books.db<br/>Parsed rows upserted)]:::storage
        E --> F[/Update process summary<br/>export books_export.csv/]:::io
        F --> G[Package run artifacts]:::process
        G --> MetaBucket[/Upload artifacts to meta bucket<br/>books.db, CSV, run metadata/]:::io
        MetaBucket --> Handoff([Handoff artifacts<br/>to sync pipeline]):::terminal
    end

    classDef terminal fill:none,stroke:#6b7280,stroke-width:2px,color:#374151
    classDef process fill:none,stroke:#3b82f6,stroke-width:2px,color:#1e40af
    classDef storage fill:none,stroke:#10b981,stroke-width:2px,color:#047857
    classDef io fill:none,stroke:#8b5cf6,stroke-width:2px,color:#5b21b6
