%%{init: {"theme": "base", "themeVariables": {"primaryTextColor": "#1e293b", "primaryBorderColor": "#475569", "lineColor": "#64748b", "background": "transparent", "mainBkg": "transparent", "secondBkg": "transparent"}, "flowchart": {"defaultRenderer": "elk", "elk": {"elk.direction": "RIGHT"}}}}%%
flowchart LR
classDef terminal fill:none,stroke:#6b7280,stroke-width:4px,color:#374151
classDef process fill:none,stroke:#3b82f6,stroke-width:4px,color:#1e40af
classDef decision fill:none,stroke:#f97316,stroke-width:4px,color:#7c2d12

Start(["Begin volume intake<br/>from sync queue"]):::terminal --> HeadGRIN["HEAD request to GRIN file package URL"]:::process
HeadGRIN --> Response{"GRIN response status"}:::decision
Response -->|200| StoragePresent{"File package in storage?"}:::decision
StoragePresent -->|no| DownloadExit(["Proceed to download task"]):::terminal
StoragePresent -->|yes| Compare{"Stored ETag matches<br/>GRIN ETag?"}:::decision
Compare -->|yes| SkipExit(["Skip download"]):::terminal
Compare -->|no| DownloadExit
Response -->|404| FailureType{"GRIN <br/>reported failure?"}:::decision
FailureType -->|yes| RecordFailure["Record failure metadata"]:::process
RecordFailure --> ErrorExit(["Stop volume<br/>await GRIN fix"]):::terminal
FailureType -->|no| RequestConversion["Request GRIN conversion<br/>for volume"]:::process
RequestConversion --> ConversionStatus{"GRIN <br/>conversion response"}:::decision
ConversionStatus -->|Requested| ConversionHold(["Conversion in flight<br/>stop processing"]):::terminal
ConversionStatus -->|In process| ConversionHold
ConversionStatus -->|Queue limit| ErrorRecord["Record queue limit error"]:::process
ConversionStatus -->|Volume is unavailable| ErrorRecord
ErrorRecord --> ErrorExit
