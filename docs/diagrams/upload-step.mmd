%%{init: {"theme": "base", "themeVariables": {"primaryTextColor": "#1e293b", "primaryBorderColor": "#475569", "lineColor": "#64748b", "background": "transparent", "mainBkg": "transparent", "secondBkg": "transparent"}, "flowchart": {"defaultRenderer": "elk", "elk": {"elk.direction": "RIGHT"}}}}%%
flowchart LR
classDef terminal fill:none,stroke:#6b7280,stroke-width:3px,color:#374151
classDef process fill:none,stroke:#3b82f6,stroke-width:3px,color:#1e40af
classDef decision fill:none,stroke:#f97316,stroke-width:3px,color:#7c2d12
classDef storage fill:none,stroke:#10b981,stroke-width:3px,color:#047857
classDef io fill:none,stroke:#8b5cf6,stroke-width:3px,color:#5b21b6

Start([Decrypted archive ready]):::terminal
Start --> LocalCheck{Local storage?}:::decision
LocalCheck -->|yes| StayLocal[Leave tar.gz in local raw bucket]:::process
StayLocal --> Result[Upload stage returns local path]:::process

LocalCheck -->|no| Metadata[Attach metadata<br/>barcode · acquisition date<br/>encrypted etag · original filename]:::io
Metadata --> StreamToRaw[Stream tar.gz from staging<br/>through BookManager write]:::process
StreamToRaw --> RawObject[(Remote raw bucket)]:::storage
RawObject --> Result
StreamToRaw -->|failure| UploadFailed([Upload failed<br/>retry chain exhausted]):::terminal

Result --> Complete([Upload step complete]):::terminal
