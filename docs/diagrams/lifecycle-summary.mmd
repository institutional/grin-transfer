%%{init: {"theme": "base", "themeVariables": {"primaryTextColor": "#1e293b", "primaryBorderColor": "#475569", "lineColor": "#64748b", "background": "transparent", "mainBkg": "transparent", "secondBkg": "transparent"}}}%%
flowchart LR
    subgraph collect [Collect Stage]
        C1([Start run<br/>grin collect<br/>with CLI args]):::terminal
        C1 --> C2[Authenticate with GRIN]:::process
        C2 --> C3[Stream GRIN catalog]:::process
        C3 --> C4[(Populate local database)]:::io
    end

    subgraph sync [Sync Stage]
        S1[/Select barcodes<br/>from queues or CLI/]:::io --> S2[Resolve package status<br/>and trigger conversions when needed]:::process
        S2 --> S3[/Download encrypted packages/]:::io
        S3 --> S4[Decrypt and unpack package contents]:::process
        S4 --> S5[/Extract metadata & OCR/]:::io
        S5 --> Buckets[/Deliver assets to <br/>meta, raw, full <br/>storage buckets or folders/]:::storage
    end

    C4 --> S1
    Buckets --> Complete([Book artifacts ready<br/>for downstream use]):::terminal

    classDef terminal fill:none,stroke:#6b7280,stroke-width:2px,color:#374151
    classDef process fill:none,stroke:#3b82f6,stroke-width:2px,color:#1e40af
    classDef io fill:none,stroke:#8b5cf6,stroke-width:2px,color:#5b21b6
    classDef storage fill:none,stroke:#10b981,stroke-width:2px,color:#047857
