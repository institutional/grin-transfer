# GRIN-to-S3

An async pipeline for extracting Google Books data from GRIN to S3.

## Requirements

- **Python 3.12+** (required for modern language features like match/case statements and union types)
- Dependencies managed via `pyproject.toml`

## Quick Start

```bash
# Install in development mode (includes all dependencies and dev tools)
pip install -e ".[dev]"

# Set up OAuth2 credentials (interactive)
python auth.py setup

# Collect books to CSV with named run
python collect_books.py --run-name "my_collection"
```

## OAuth2 Setup

The `auth.py setup` command walks you through:

1. **Client Configuration**: Creates Google Cloud OAuth2 application
2. **Authorization Flow**: Browser-based Google authentication  
3. **Credential Storage**: Secure JSON credential files
4. **Testing**: Verifies authentication works with GRIN

### Required Files
Credentials are stored in `~/.config/grin-to-s3/`:
- `client_secret.json` or `secrets.json` - OAuth2 client configuration (from Google Cloud Console)
- `credentials.json` or `token.json` - User authentication tokens (generated by setup)

## Book Collection

The book collection system generates comprehensive book metadata exports from GRIN with processing state information.

- `python collect_books.py` 

### Basic Usage

```bash
# Basic collection with named run
python collect_books.py --run-name "harvard_2024"

# Test mode (no network calls, uses mock data)
python collect_books.py --test-mode --limit 100

# With custom output file and rate limiting
python collect_books.py books.csv --rate-limit 2.0 --limit 1000
```

### Configuration

Create a configuration file for consistent settings:

```bash
# Generate default config
python collect_books.py --create-config my_config.json

# Use config file with named run
python collect_books.py --config-file my_config.json --run-name "configured_run"
```

**Configuration Format** (`my_config.json`):
```json
{
  "directory": "Harvard",
  "rate_limit": 5.0,
  "data_mode": "html",
  "pagination": {
    "page_size": 10000,
    "max_pages": 1000,
    "start_page": 1
  },
  "resume_file": "collect_books_progress.json",
  "burst_limit": 10
}
```

### Data Modes

**HTML Mode (default)**: `"data_mode": "html"`
- Uses paginated HTML table parsing
- Better for large datasets with pagination
- Supports resume functionality
- Returns book titles and structured data

**Text Mode**: `"data_mode": "text"`  
- Uses streaming plaintext API
- Simpler data format
- Better for smaller datasets or testing
- Legacy format compatibility

### Advanced Options

```bash
# Custom pagination
python collect_books.py --run-name "large_collection" --page-size 500 --max-pages 2000

# Use streaming text mode instead of HTML pagination
python collect_books.py --run-name "text_mode" --data-mode text

# With storage backend for archive checking
python collect_books.py --run-name "s3_check" --storage s3 --storage-config bucket=my-bucket

# Named run with custom settings
python collect_books.py --run-name "harvard_2024" --limit 1000

# Debug logging
python collect_books.py --run-name "debug_run" --log-level DEBUG
```

### Output Format

The book collection CSV includes these fields:
- **Core**: Barcode, Title, Processing State
- **GRIN Timestamps**: Scanned, Converted, Downloaded, Processed, Analyzed, OCR dates
- **GRIN Enrichment**: State, Viewability, Conditions, Scannable, Tagging, Audit
- **Quality Metrics**: Material Error %, Overall Error %, OCR Analysis Score
- **Metadata**: Google Books Link, Digitization Method
- **Tracking**: CSV Exported, CSV Updated timestamps

### Resume Functionality

Collections automatically save progress and can be resumed:
- Progress files stored in run-specific directories (`output/{run_name}/`)
- SQLite database tracks processed books
- Resume from exact stopping point
- No duplicate processing

### Performance

- **Rate Limiting**: Configurable API requests per second (default: 5.0)
- **Pagination**: Large page sizes for efficient API usage (default: 10000)
- **Progress Tracking**: Real-time progress with ETA calculations
- **Concurrent Safety**: File locking prevents multiple simultaneous exports

## GRIN Metadata Enrichment

After collecting books, you can enrich them with detailed GRIN metadata:

### Basic Enrichment

```bash
# Check enrichment status
python grin_enrichment.py status output/default/books.db

# Start enrichment process
python grin_enrichment.py enrich output/default/books.db

# Enrich with custom settings
python grin_enrichment.py enrich output/default/books.db \
  --batch-size 500 \
  --grin-batch-size 100 \
  --rate-limit 0.2 \
  --max-concurrent 3
```

### Advanced Enrichment Options

```bash
# Reset and re-enrich all books
python grin_enrichment.py enrich output/default/books.db --reset

# Limit enrichment to specific number of books
python grin_enrichment.py enrich output/default/books.db --limit 10000

# Export enriched data to CSV
python grin_enrichment.py export-csv output/default/books.db --output enriched_books.csv
```

### Enrichment Parameters

- `--batch-size`: Number of books to fetch from database at once (default: 1000)
- `--grin-batch-size`: Number of barcodes per GRIN API request (default: 200)
- `--rate-limit`: Delay between requests in seconds (default: 0.2s for 5 QPS)
- `--max-concurrent`: Maximum concurrent GRIN requests (default: 5)

### Enriched Data Fields

The enrichment adds detailed GRIN metadata:
- **Processing State**: GRIN state, viewability, conditions
- **Quality Metrics**: Material error %, overall error %, OCR analysis scores
- **Metadata**: Digitization method, tagging, audit information
- **Availability**: Opted-out status, scannable status

## Key Features

- **Async architecture** with Python 3.12+
- **Minimal dependencies** for easy installation
- **Resume functionality** for interrupted operations
- **Comprehensive logging** and progress tracking
- **Easy installation** for other libraries

## Architecture

### Core Modules
- `auth.py` - OAuth2 authentication with google-auth
- `client.py` - Async GRIN API client with aiohttp  
- `common.py` - Shared utilities and progress tracking
- `storage.py` - S3/MinIO/R2 storage abstractions

### Book Collection Module (`collect_books/`)
- `models.py` - BookRecord and RateLimiter data models
- `exporter.py` - Main BookCollector class and collection logic
- `config.py` - Configuration management and pagination settings
- `__main__.py` - CLI interface (`python -m collect_books`)

### Top-Level Scripts
- `collect_books.py` - Convenient wrapper script for book collection
- `grin_enrichment.py` - GRIN metadata enrichment pipeline

## Dependencies

Modern Python 3.12+ with curated dependencies:
- `aiohttp` - Async HTTP client
- `google-auth` - OAuth2 authentication  
- `aiosqlite` - Async SQLite database operations
- `selectolax` - Fast HTML parsing for GRIN responses
- `aioboto3` - Async AWS operations
- `aiofiles` - Async file I/O
- `fsspec`/`s3fs`/`gcsfs` - Storage abstraction
- `tenacity` - Retry logic
- `pytest` - Testing framework

## Development

### Code Quality Tools

The project includes modern development tools (install with `pip install -e ".[dev]"`):

```bash
# Run linting (fixes most issues automatically)
ruff check --fix

# Run code formatting (Ruff formatter, compatible with Black)
ruff format

# Run type checking
mypy --explicit-package-bases *.py

# Run all quality checks
ruff check --fix && ruff format && mypy --explicit-package-bases *.py
```

### Testing

Run the test suite to verify functionality:

```bash
# Run all tests
python -m pytest

# Run book collection tests only
python -m pytest tests/ -k "collect_books"

# Run with verbose output
python -m pytest tests/unit/test_collect_books.py -v
```

## Troubleshooting

### Common Issues

**Authentication Error**: 
```bash
python auth.py setup  # Re-run OAuth2 setup
```

**Module Not Found**:
```bash
source venv/bin/activate  # Ensure virtual environment is active
pip install -e ".[dev]"  # Install dependencies in development mode
```

**Permission Denied**:
```bash
chmod +x activate.sh  # Make activation script executable
```

**Book Collection Fails**:
```bash
# Try test mode first
python collect_books.py --test-mode --limit 10

# Check status of existing collection
python grin_enrichment.py status output/default/books.db
```
