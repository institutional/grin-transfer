name: Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run type checking
      run: |
        mypy src/grin_to_s3/ --explicit-package-bases
    
    - name: Run linting
      run: |
        ruff check .

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run tests
      run: |
        python -m pytest src/tests/ -v --tb=short

  docker:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Create required directories and dummy credentials
      run: |
        mkdir -p docker-data/{data,output,logs,staging}
        mkdir -p ~/.config/grin-to-s3
        # Create dummy client secret file for Docker tests
        cp examples/auth/client_secret.json ~/.config/grin-to-s3/client_secret.json
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Test Docker image build with cache
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: grin-to-s3:test
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Test Docker Compose (basic service)
      run: |
        docker compose up -d grin-to-s3
        # Wait for service to be ready
        sleep 10
        docker compose ps | grep -q "grin-to-s3"
        docker compose down
    
    - name: Test Docker Compose (MinIO profile)
      run: |
        docker compose --profile minio up -d
        
        # Wait for setup to complete
        while docker compose ps minio-client | grep -q "running"; do
          echo "Waiting for MinIO setup..."
          sleep 2
        done
        
        # Show setup logs for debugging
        echo "MinIO setup logs:"
        docker compose logs minio-client
        
        # Verify MinIO server is running
        docker compose ps | grep -q "minio.*Up"
        
        # Verify connectivity using application's MinIO check
        docker compose exec grin-to-s3 python -c "
        import asyncio
        import sys
        sys.path.append('/app/src')
        from grin_to_s3.common import check_minio_connectivity
        
        async def test_connectivity():
            config = {
                'endpoint_url': 'http://minio:9000',
                'access_key': 'minioadmin',
                'secret_key': 'minioadmin123'
            }
            await check_minio_connectivity(config)
            print('✅ MinIO connectivity verified via application code')
        
        asyncio.run(test_connectivity())
        "
        
        docker compose down
    
    - name: Test grin-docker wrapper script basic functionality
      run: |
        chmod +x grin-docker
        ./grin-docker python grin.py --help | grep -q "GRIN-to-S3"
    
    - name: Test MinIO configuration functions
      run: |
        chmod +x grin-docker
        docker compose --profile minio up -d
        
        # Wait for setup to complete
        while docker compose ps minio-client | grep -q "running"; do
          echo "Waiting for MinIO setup..."
          sleep 2
        done

        # Test that MinIO connectivity check works
        docker compose exec grin-to-s3 python -c "
        import asyncio
        import sys
        sys.path.append('/app/src')
        from grin_to_s3.common import auto_configure_minio, check_minio_connectivity
        
        async def test_minio_config():
            # Test auto-configuration
            config = {}
            auto_configure_minio(config)
            
            # Verify expected configuration
            assert config['endpoint_url'] == 'http://minio:9000', f'Expected http://minio:9000, got {config.get(\"endpoint_url\")}'
            assert config['bucket_raw'] == 'grin-raw', f'Expected grin-raw, got {config.get(\"bucket_raw\")}'
            assert config['bucket_meta'] == 'grin-meta', f'Expected grin-meta, got {config.get(\"bucket_meta\")}'
            assert config['bucket_full'] == 'grin-full', f'Expected grin-full, got {config.get(\"bucket_full\")}'
            
            # Test connectivity
            await check_minio_connectivity(config)
            print('✅ MinIO configuration and connectivity tests passed')
        
        asyncio.run(test_minio_config())
        "
        
        docker compose down
    
    - name: Test storage factory integration
      run: |
        chmod +x grin-docker
        docker compose --profile minio up -d
        
        # Wait for setup to complete
        while docker compose ps minio-client | grep -q "running"; do
          echo "Waiting for MinIO setup..."
          sleep 2
        done
        
        # Test that storage factories work with MinIO auto-configuration
        docker compose exec grin-to-s3 python -c "
        import sys
        sys.path.append('/app/src')
        from grin_to_s3.storage.factories import create_storage_from_config
        from grin_to_s3.storage.book_manager import BookManager
        from grin_to_s3.common import auto_configure_minio
        
        def test_storage_factories():
            # Test storage factory with empty config (should auto-configure)
            print('Creating storage config...')
            storage_config = {
                'type': 'minio',
                'protocol': 's3', 
                'config': {}
            }
            print(f'Storage config created: {storage_config}')
            print('Calling create_storage_from_config...')
            storage = create_storage_from_config(storage_config)
            print('✅ Storage factory works with auto-configuration')
            
            # Test book manager factory with proper bucket configuration
            config = {}
            auto_configure_minio(config)
            storage_config_with_buckets = {
                'type': 'minio',
                'protocol': 's3',
                'config': config
            }
            storage = create_storage_from_config(storage_config_with_buckets)
            book_manager = BookManager(storage=storage, storage_config=storage_config_with_buckets)
            
            # Verify bucket configuration was set
            assert book_manager.bucket_raw == 'grin-raw', f'Expected grin-raw, got {book_manager.bucket_raw}'
            assert book_manager.bucket_meta == 'grin-meta', f'Expected grin-meta, got {book_manager.bucket_meta}'
            assert book_manager.bucket_full == 'grin-full', f'Expected grin-full, got {book_manager.bucket_full}'
            
            print('✅ Book manager factory works with auto-configuration')
        
        test_storage_factories()
        "
        
        docker compose down