#!/bin/bash
# grin-docker - Docker wrapper for grin-to-s3 CLI tool
#
# This script provides a convenient way to run grin-to-s3 commands inside Docker
# while maintaining the same CLI interface as the native tool.
#
# Usage:
#   ./grin-docker collect --run-name test --storage minio --limit 5
#   ./grin-docker sync pipeline --run-name test
#   ./grin-docker bash
#
# Environment variables:
#   COMPOSE_FILE - Docker Compose file to use (default: docker-compose.yml)
#   SERVICE_NAME - Service name to execute commands in (default: grin-to-s3)

set -e

# Get script directory for relative paths
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Allow environment variable overrides
COMPOSE_FILE="${COMPOSE_FILE:-docker-compose.yml}"
SERVICE_NAME="${SERVICE_NAME:-grin-to-s3}"

# Set container prefix and instance ID if not provided
export GRIN_CONTAINER_PREFIX="${GRIN_CONTAINER_PREFIX:-grin-to-s3}"
export GRIN_INSTANCE_ID="${GRIN_INSTANCE_ID:-dev}"

# Full path to compose file
COMPOSE_PATH="$SCRIPT_DIR/$COMPOSE_FILE"

# Check if compose file exists
if [ ! -f "$COMPOSE_PATH" ]; then
    echo "Error: Docker Compose file not found: $COMPOSE_PATH"
    echo "Make sure you're running this script from the project root directory."
    exit 1
fi

# Handle auth setup before starting container
if [ "$1" = "auth" ] && [ "$2" = "setup" ]; then
    echo "Setting up authentication credentials..."
    
    # Create credentials directory if it doesn't exist
    CREDS_DIR="$HOME/.config/grin-to-s3"
    if [ ! -d "$CREDS_DIR" ]; then
        echo "Credentials directory doesn't exist: $CREDS_DIR"
        read -p "Create it now? (y/N): " -r
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            mkdir -p "$CREDS_DIR"
            echo "Created $CREDS_DIR"
        else
            echo "Cannot proceed without credentials directory"
            exit 1
        fi
    fi
    
    # Check if client_secret.json exists
    if [ ! -f "$CREDS_DIR/client_secret.json" ]; then
        echo ""
        echo "Missing OAuth 2.0 client secrets file: $CREDS_DIR/client_secret.json"
        echo ""
        echo "To obtain your credentials:"
        echo "1. Go to: https://console.cloud.google.com/apis/credentials"
        echo "2. Create a new project or select existing"
        echo "3. Click 'Create Credentials' → 'OAuth 2.0 Client IDs'"
        echo "4. Application type: 'Desktop application'"
        echo "5. Download the JSON file"
        echo "6. Save it as: $CREDS_DIR/client_secret.json"
        echo ""
        echo "Or copy the template: cp examples/auth/client_secret.json $CREDS_DIR/client_secret.json"
        echo "Then edit it with your OAuth2 credentials"
        exit 1
    fi
    
    # Clear extended attributes that can cause Docker mount issues on macOS
    if command -v xattr >/dev/null 2>&1; then
        xattr -c "$CREDS_DIR/client_secret.json" 2>/dev/null || true
    fi
    
    # Check for optional credential files and inform user
if [ ! -f "$CREDS_DIR/gpg_passphrase.asc" ]; then
        echo "Note: GPG passphrase file not found - add $CREDS_DIR/gpg_passphrase.asc if needed for archive decryption"
    fi
    
    if [ ! -f "$CREDS_DIR/r2_credentials.json" ]; then
        echo "Note: R2 credentials file not found - copy examples/auth/r2-credentials-template.json to $CREDS_DIR/r2_credentials.json if using R2 storage"
    fi
    
    echo "Credentials directory prepared. Starting container for OAuth2 setup..."
fi

# Prepare the command to execute
if [ "$1" = "bash" ]; then
    # Special case: bash opens an interactive shell
    COMMAND="bash"
else
    # Default: prepend python grin.py to the command
    COMMAND="python grin.py $*"
fi

# Start minio service
PROFILES="--profile minio"

# Check for missing GPG passphrase file and warn
CREDS_DIR="$HOME/.config/grin-to-s3"
if [ ! -f "$CREDS_DIR/gpg_passphrase.asc" ]; then
    echo ""
    echo "⚠️  WARNING: GPG passphrase file not found!"
    echo "    Archive decryption will fail without: $CREDS_DIR/gpg_passphrase.asc"
    echo "    Add your GPG passphrase to this file if you need to decrypt archives"
    echo ""
fi

# Check if services are already running
if ! docker compose -f "$COMPOSE_PATH" ps "$SERVICE_NAME" 2>/dev/null | grep -q "Up"; then
    echo "Starting Docker services..."
    if [ "$GRIN_INSTANCE_ID" != "dev" ]; then
        echo "Using instance ID: $GRIN_INSTANCE_ID"
    fi
    if [ -n "$PROFILES" ]; then
        echo "Starting with MinIO profile..."
    fi
    
    # Start services with visible output
    if [ -n "$PROFILES" ]; then
        # When using profiles, start all services in the profile
        if ! docker compose -f "$COMPOSE_PATH" $PROFILES up -d; then
            echo "Error: Failed to start services with profile"
            echo "Try running: docker compose -f $COMPOSE_FILE $PROFILES up -d"
            exit 1
        fi
    else
        # When not using profiles, start just the main service
        if ! docker compose -f "$COMPOSE_PATH" up -d "$SERVICE_NAME"; then
            echo "Error: Failed to start $SERVICE_NAME service"
            echo "Try running: docker compose -f $COMPOSE_FILE up -d"
            exit 1
        fi
    fi
    
    echo "Services started successfully."
else
    # Services already running, no output needed
    :
fi

# Execute command
exec docker compose -f "$COMPOSE_PATH" exec "$SERVICE_NAME" $COMMAND